<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Salla Cart Integration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
    </style>
</head>
<body>
    <h1>Salla Cart Integration Test</h1>
    
    <div class="test-section">
        <h2>1. Test Authentication Status</h2>
        <button onclick="testAuth()">Check Authentication</button>
        <div id="auth-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Test Products API</h2>
        <button onclick="testProducts()">Fetch Products</button>
        <div id="products-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Test Cart API (Backend)</h2>
        <button onclick="testCartAPI()">Test Cart Endpoint</button>
        <div id="cart-api-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Test Salla SDK Availability</h2>
        <button onclick="testSallaSDK()">Check Salla SDK</button>
        <div id="sdk-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>5. Test Add to Cart (SDK)</h2>
        <input type="number" id="product-id" placeholder="Product ID" value="1">
        <input type="number" id="quantity" placeholder="Quantity" value="1">
        <button onclick="testAddToCart()">Add to Cart</button>
        <div id="add-cart-result" class="result"></div>
    </div>

    <script>
        async function testAuth() {
            const resultDiv = document.getElementById('auth-result');
            try {
                const response = await fetch('/api/test-auth');
                const data = await response.json();
                resultDiv.textContent = JSON.stringify(data, null, 2);
                resultDiv.className = 'result ' + (data.hasToken ? 'success' : 'error');
            } catch (error) {
                resultDiv.textContent = 'Error: ' + error.message;
                resultDiv.className = 'result error';
            }
        }
        
        async function testProducts() {
            const resultDiv = document.getElementById('products-result');
            try {
                const response = await fetch('/api/products');
                const data = await response.json();
                resultDiv.textContent = JSON.stringify(data, null, 2);
                resultDiv.className = 'result ' + (data.success ? 'success' : 'error');
            } catch (error) {
                resultDiv.textContent = 'Error: ' + error.message;
                resultDiv.className = 'result error';
            }
        }
        
        async function testCartAPI() {
            const resultDiv = document.getElementById('cart-api-result');
            try {
                const response = await fetch('/api/cart');
                const data = await response.json();
                resultDiv.textContent = JSON.stringify(data, null, 2);
                resultDiv.className = 'result ' + (response.ok ? 'success' : 'error');
            } catch (error) {
                resultDiv.textContent = 'Error: ' + error.message;
                resultDiv.className = 'result error';
            }
        }
        
        function testSallaSDK() {
            const resultDiv = document.getElementById('sdk-result');
            const hasSalla = typeof window.salla !== 'undefined';
            const isReady = typeof window.sallaSDKReady !== 'undefined' && window.sallaSDKReady;
            
            const result = {
                sallaExists: hasSalla,
                sdkReady: isReady,
                windowSalla: typeof window.salla,
                sallaObject: hasSalla ? Object.keys(window.salla) : 'N/A'
            };
            
            resultDiv.textContent = JSON.stringify(result, null, 2);
            resultDiv.className = 'result ' + (hasSalla && isReady ? 'success' : 'error');
        }
        
        async function testAddToCart() {
            const resultDiv = document.getElementById('add-cart-result');
            const productId = document.getElementById('product-id').value;
            const quantity = document.getElementById('quantity').value;
            
            try {
                // Check if Salla SDK is available
                if (typeof window.salla === 'undefined') {
                    throw new Error('Salla SDK is not available. Make sure you have a real Salla store configured.');
                }
                
                if (!window.sallaSDKReady) {
                    throw new Error('Salla SDK is not ready yet. Please wait for initialization.');
                }
                
                // Set up event listeners
                window.salla.cart.event.onItemAdded((response) => {
                    resultDiv.textContent = 'SUCCESS: Item added to cart\n' + JSON.stringify(response, null, 2);
                    resultDiv.className = 'result success';
                });
                
                window.salla.cart.event.onItemAddedFailed((error) => {
                    resultDiv.textContent = 'FAILED: Could not add item to cart\n' + JSON.stringify(error, null, 2);
                    resultDiv.className = 'result error';
                });
                
                // Attempt to add item
                const cartOptions = {
                    id: parseInt(productId),
                    quantity: parseInt(quantity),
                    notes: "Added from test page"
                };
                
                resultDiv.textContent = 'Adding to cart with options: ' + JSON.stringify(cartOptions, null, 2);
                resultDiv.className = 'result';
                
                await window.salla.cart.addItem(cartOptions);
                
            } catch (error) {
                resultDiv.textContent = 'Error: ' + error.message;
                resultDiv.className = 'result error';
            }
        }
        
        // Auto-run tests on page load
        window.addEventListener('load', () => {
            testAuth();
            testSallaSDK();
        });
    </script>
</body>
</html>